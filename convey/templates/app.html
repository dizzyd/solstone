<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ app_registry.apps[app].label }} - Sunstone</title>
  <link rel="stylesheet" href="{{ url_for('review.static', filename='review.css') }}">
  <link rel="stylesheet" href="{{ url_for('review.static', filename='app.css') }}">

  <!-- Embed facets data for immediate client-side access -->
  <script>
    window.facetsData = {{ facets|tojson|safe }};
    window.selectedFacetFromServer = {{ selected_facet|tojson|safe }};
    window.appFacetCounts = {{ app_registry.apps[app].get_facet_counts(facets, selected_facet)|tojson|safe }};
  </script>

  <!-- WebSocket connection for Callosum events -->
  <script src="{{ url_for('review.static', filename='websocket.js') }}"></script>

  <!-- Apply facet theme immediately to prevent flash -->
  {% if selected_facet %}
  {% set selected_facet_data = facets|selectattr("name", "equalto", selected_facet)|first %}
  {% if selected_facet_data and selected_facet_data.color %}
  <style>
    :root {
      --facet-color: {{ selected_facet_data.color }};
      --facet-bg: {{ selected_facet_data.color }}1a;  /* 10% opacity */
      --facet-border: {{ selected_facet_data.color }};
    }
  </style>
  {% endif %}
  {% endif %}
</head>
<body{% if app_registry.apps[app].get_app_bar_template() %} class="has-app-bar"{% endif %}>
<!-- Menu Bar -->
{% include "menu_bar.html" %}

<!-- Facet Bar (top) -->
<div class="facet-bar">
  <div id="hamburger">â˜°</div>
  <div class="app-icon">{{ apps[app]['icon'] }}</div>
  <div class="facet-pills-container"></div>
  <div class="status-icon">ðŸŸ¢</div>
</div>

<!-- Status Pane -->
{% include "status_pane.html" %}

<!-- App Bar (bottom) - only render if app provides template -->
{% set app_bar_template = app_registry.apps[app].get_app_bar_template() %}
{% if app_bar_template %}
<div class="app-bar">
  <div class="workspace">
    {% include app_bar_template %}
  </div>
</div>
{% endif %}

<!-- Main Content -->
<div class="container">
  {% include app_registry.apps[app].get_workspace_template() %}
</div>

<!-- App JavaScript -->
<script src="{{ url_for('review.static', filename='app.js') }}"></script>

<!-- App Services Framework -->
<script>
/**
 * Global App Services Framework
 *
 * Allows apps to register background services that run globally (even when
 * the app is not active). Services can listen to WebSocket events, update
 * badges, show notifications, and run custom logic.
 *
 * Similar to iOS background notification handlers.
 */
window.AppServices = {
  services: {},

  /**
   * Register an app background service
   * @param {string} appName - Name of the app
   * @param {object} service - Service object with initialize() method
   */
  register(appName, service) {
    this.services[appName] = service;
    if (service.initialize) {
      try {
        service.initialize();
      } catch (err) {
        console.error(`[AppServices] Failed to initialize ${appName} service:`, err);
      }
    }
  },

  /**
   * Update badge count for a facet or app
   * @param {string} appName - Name of the app
   * @param {string|null} facetName - Facet name, or null for app-level badge
   * @param {number} count - Badge count (0 to hide)
   */
  updateBadge(appName, facetName, count) {
    if (facetName) {
      // Update facet pill badge
      const facetPill = document.querySelector(`.facet-pill[data-facet="${facetName}"]`);
      if (facetPill) {
        let badge = facetPill.querySelector('.facet-badge');
        if (!badge) {
          badge = document.createElement('span');
          badge.className = 'facet-badge';
          facetPill.appendChild(badge);
        }
        badge.textContent = count || '';
        badge.style.display = count > 0 ? 'inline-block' : 'none';
      }

      // Update submenu badge for facet
      const submenuItem = document.querySelector(
        `.menu-item[data-app="${appName}"] .submenu-item[data-facet="${facetName}"]`
      );
      if (submenuItem) {
        let badge = submenuItem.querySelector('.submenu-badge');
        if (!badge) {
          badge = document.createElement('span');
          badge.className = 'submenu-badge';
          submenuItem.appendChild(badge);
        }
        badge.textContent = count || '';
        badge.style.display = count > 0 ? 'inline-block' : 'none';
      }
    } else {
      // Update app-level badge in menu
      const menuItem = document.querySelector(`.menu-item[data-app="${appName}"]`);
      if (menuItem) {
        let badge = menuItem.querySelector('.app-badge');
        if (!badge) {
          badge = document.createElement('span');
          badge.className = 'app-badge';
          menuItem.querySelector('a').appendChild(badge);
        }
        badge.textContent = count || '';
        badge.style.display = count > 0 ? 'inline-block' : 'none';
      }
    }
  },

  /**
   * Update submenu items for an app
   * @param {string} appName - Name of the app
   * @param {Array} items - Array of {label, path, facet?, count?} objects
   */
  updateSubmenu(appName, items) {
    const submenu = document.querySelector(`.menu-item[data-app="${appName}"] .submenu`);
    if (!submenu) return;

    submenu.innerHTML = items.map(item => `
      <div class="submenu-item" ${item.facet ? `data-facet="${item.facet}"` : ''}>
        <a href="${item.path}">${item.label}</a>
        ${item.count ? `<span class="submenu-badge">${item.count}</span>` : ''}
      </div>
    `).join('');
  },

  /**
   * Show a notification (browser or in-app toast)
   * @param {string} title - Notification title
   * @param {string} body - Notification body
   * @param {object} options - {icon, tag, duration}
   */
  notify(title, body, options = {}) {
    // Try browser notification if permitted
    if ('Notification' in window && Notification.permission === 'granted') {
      new Notification(title, {
        body,
        icon: options.icon,
        tag: options.tag
      });
    }

    // Always show in-app toast
    const toast = document.createElement('div');
    toast.className = 'app-notification';
    toast.innerHTML = `
      <div class="notification-icon">${options.icon || 'ðŸ“¬'}</div>
      <div class="notification-content">
        <strong>${this._escapeHtml(title)}</strong>
        <p>${this._escapeHtml(body)}</p>
      </div>
    `;
    document.body.appendChild(toast);

    // Animate in
    setTimeout(() => toast.classList.add('show'), 10);

    // Auto-dismiss
    const duration = options.duration || 5000;
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, duration);
  },

  /**
   * Request browser notification permission
   * @returns {Promise<string>} Permission state
   */
  async requestNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
      return await Notification.requestPermission();
    }
    return Notification.permission;
  },

  /**
   * Escape HTML to prevent XSS in notifications
   * @private
   */
  _escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
};
</script>

<!-- Load all app background services -->
{% for app_name, app_instance in app_registry.apps.items() %}
  {% set service_tpl = app_instance.get_service_template() %}
  {% if service_tpl %}
<!-- Background service: {{ app_name }} -->
<script>
(function() {
  try {
    {% set blueprint = app_instance.get_blueprint() %}
    {% with current_app = app_name %}
    {% include service_tpl %}
    {% endwith %}
  } catch (err) {
    console.error('[AppServices] Failed to load {{ app_name }} service:', err);
  }
})();
</script>
  {% endif %}
{% endfor %}

<!-- Notification Toast Styles -->
<style>
.app-notification {
  position: fixed;
  bottom: 80px;
  right: 20px;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  padding: 1rem;
  display: flex;
  gap: 0.75rem;
  align-items: flex-start;
  max-width: 360px;
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.3s ease, transform 0.3s ease;
  z-index: 10000;
}

.app-notification.show {
  opacity: 1;
  transform: translateY(0);
}

.app-notification .notification-icon {
  font-size: 1.5rem;
  flex-shrink: 0;
}

.app-notification .notification-content {
  flex: 1;
  min-width: 0;
}

.app-notification .notification-content strong {
  display: block;
  margin-bottom: 0.25rem;
  color: #1f2937;
  font-size: 0.95rem;
}

.app-notification .notification-content p {
  margin: 0;
  color: #6b7280;
  font-size: 0.875rem;
  line-height: 1.4;
}

/* Badge styles (if not already defined) */
.facet-badge, .submenu-badge, .app-badge {
  display: inline-block;
  background: #ef4444;
  color: white;
  font-size: 0.75rem;
  font-weight: bold;
  padding: 0.125rem 0.375rem;
  border-radius: 10px;
  margin-left: 0.5rem;
  min-width: 1.25rem;
  text-align: center;
}

.app-badge {
  margin-left: auto;
  margin-right: 0;
}
</style>

</body>
</html>
