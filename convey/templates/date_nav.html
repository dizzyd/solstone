{# Date Nav - renders below facet bar when app has date_nav enabled #}
{# Requires: day (YYYYMMDD), day_formatted ("Sat Nov 29"), app (app name) #}
{% if day %}
<div class="date-nav">
  <button class="date-nav-arrow" id="date-nav-prev" title="Previous day (&#8592)">&#8249;</button>
  <span class="date-nav-label" id="date-nav-label" title="Pick date">{{ day_formatted }}</span>
  <input type="date" id="date-nav-input">
  <button class="date-nav-arrow" id="date-nav-next" title="Next day (&#8594)">&#8250;</button>
</div>

<script>
(function() {
  const currentDay = '{{ day }}';
  const app = '{{ app }}';
  const baseUrl = `/app/${app}/`;

  function toInputFormat(day) {
    return `${day.substring(0, 4)}-${day.substring(4, 6)}-${day.substring(6, 8)}`;
  }

  function fromInputFormat(str) {
    return str.replace(/-/g, '');
  }

  function adjustDay(day, delta) {
    const year = parseInt(day.substring(0, 4));
    const month = parseInt(day.substring(4, 6)) - 1;
    const dayNum = parseInt(day.substring(6, 8));
    const date = new Date(year, month, dayNum);
    date.setDate(date.getDate() + delta);
    return date.getFullYear() +
      String(date.getMonth() + 1).padStart(2, '0') +
      String(date.getDate()).padStart(2, '0');
  }

  function getTodayDay() {
    const now = new Date();
    return now.getFullYear() +
      String(now.getMonth() + 1).padStart(2, '0') +
      String(now.getDate()).padStart(2, '0');
  }

  function navigate(day) {
    window.location.href = `${baseUrl}${day}`;
  }

  const picker = document.getElementById('date-nav-input');
  const label = document.getElementById('date-nav-label');

  // Set initial picker value
  picker.value = toInputFormat(currentDay);

  // Click label to open date picker
  label.addEventListener('click', () => picker.showPicker());

  // Date picker change handler
  picker.addEventListener('change', (e) => {
    const newDay = fromInputFormat(e.target.value);
    if (newDay && newDay !== currentDay) {
      navigate(newDay);
    }
  });

  // Button handlers
  document.getElementById('date-nav-prev').addEventListener('click', () => navigate(adjustDay(currentDay, -1)));
  document.getElementById('date-nav-next').addEventListener('click', () => navigate(adjustDay(currentDay, 1)));

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (e.target.matches('input, textarea, select')) return;

    if (e.key === 'ArrowLeft') {
      e.preventDefault();
      navigate(adjustDay(currentDay, -1));
    }
    if (e.key === 'ArrowRight') {
      e.preventDefault();
      navigate(adjustDay(currentDay, 1));
    }
    if (e.key === 't' || e.key === 'T') {
      e.preventDefault();
      navigate(getTodayDay());
    }
  });
})();
</script>
{% endif %}
