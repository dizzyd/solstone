{% extends 'base.html' %}
{% set title = facet_data.title or facet_name %}
{% set active = 'facets' %}
{% block head %}
<style>
/* Facet header */
.facet-header {
  position: relative;
  width: 100%;
  padding: 3em 2em;
  margin-bottom: 2em;
  color: white;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 0 0 16px 16px;
  overflow: hidden;
  box-sizing: border-box;
}

.facet-header.has-color {
  background: var(--facet-color);
}

.facet-header-content {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5em;
}

.facet-header-left {
  display: flex;
  align-items: center;
  gap: 0.5em;
}

.facet-header-right {
  display: flex;
  align-items: center;
  gap: 1em;
}

/* Toggle switch for agents */
.agents-toggle {
  display: flex;
  align-items: center;
  gap: 0.5em;
  padding: 0.5em 1em;
  background: rgba(255, 255, 255, 0.15);
  border-radius: 8px;
  backdrop-filter: blur(10px);
}

.agents-toggle-label {
  font-size: 0.9em;
  font-weight: 500;
  color: white;
  opacity: 0.9;
}

.toggle-switch {
  position: relative;
  display: inline-block;
  width: 44px;
  height: 24px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(255, 255, 255, 0.3);
  transition: 0.3s;
  border-radius: 24px;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
}

input:checked + .toggle-slider {
  background-color: rgba(76, 175, 80, 0.8);
}

input:checked + .toggle-slider:before {
  transform: translateX(20px);
}

.toggle-slider:hover {
  background-color: rgba(255, 255, 255, 0.4);
}

input:checked + .toggle-slider:hover {
  background-color: rgba(76, 175, 80, 0.9);
}

.facet-header .facet-emoji {
  font-size: 2.5em;
  opacity: 0.9;
}

.facet-header h1 {
  margin: 0;
  font-size: 2.5em;
  font-weight: 700;
  color: white;
  background: none;
  -webkit-background-clip: unset;
  -webkit-text-fill-color: unset;
  background-clip: unset;
}


/* Back button */
.back-button {
  position: absolute;
  top: 1em;
  left: 1em;
  color: white;
  text-decoration: none;
  font-size: 1.1em;
  opacity: 0.8;
  transition: opacity 0.2s;
}

.back-button:hover {
  opacity: 1;
  color: white;
}

/* Tab navigation */
.tab-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 2em;
  box-sizing: border-box;
  overflow-x: auto;
}

.tab-nav {
  display: flex;
  border-bottom: 2px solid #eee;
  margin-bottom: 2em;
}

.tab-button {
  background: none;
  border: none;
  padding: 1em 2em;
  font-size: 1.1em;
  font-weight: 500;
  color: #666;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  transition: all 0.2s;
}

.tab-button:hover {
  color: #333;
  background: #f8f9fa;
}

.tab-button.active {
  color: #667eea;
  border-bottom-color: #667eea;
  background: #f8f9ff;
}

.tab-link {
  display: flex;
  align-items: center;
  padding: 1em 2em;
  font-size: 1.1em;
  font-weight: 500;
  color: #666;
  text-decoration: none;
  border-bottom: 3px solid transparent;
  transition: all 0.2s;
  margin-left: auto;
}

.tab-link:hover {
  color: #667eea;
  background: #f8f9fa;
}

.tab-link .gear-icon {
  transition: transform 0.3s ease;
}

.tab-link:hover .gear-icon {
  transform: rotate(90deg);
}

/* Tab content */
.tab-content {
  display: none;
  padding: 1em 0;
}

.tab-content.active {
  display: block;
}

.tab-content h2 {
  color: #333;
  margin-bottom: 1.5em;
  font-size: 1.8em;
}

/* Placeholder content styling */
.placeholder {
  text-align: center;
  padding: 4em;
  color: #666;
  background: #f8f9fa;
  border-radius: 12px;
  border: 2px dashed #ddd;
}

.placeholder h3 {
  color: #999;
  margin-bottom: 1em;
}

.placeholder p {
  line-height: 1.6;
  max-width: 600px;
  margin: 0 auto;
}


/* Description tab content styling */
.description-content {
  max-width: 800px;
}

.description-content p {
  font-size: 1.1em;
  line-height: 1.6;
  color: #333;
  margin-bottom: 2em;
}

/* Description modal */
.description-modal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.6);
}

.description-modal-content {
  background-color: white;
  margin: 10% auto;
  border-radius: 12px;
  width: 90%;
  max-width: 600px;
  position: relative;
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  overflow: hidden;
}

.description-close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  line-height: 1;
  position: absolute;
  top: 15px;
  right: 20px;
  background: white;
  z-index: 3;
  transition: color 0.2s;
}

.description-close:hover {
  color: #000;
}

.description-modal-header {
  padding: 20px 40px 15px 20px;
  border-bottom: 1px solid #e0e0e0;
  background: white;
  border-radius: 12px 12px 0 0;
}

.description-modal-header h3 {
  margin: 0;
  color: #333;
  font-size: 1.4em;
}

.description-modal-body {
  padding: 20px;
}

#descriptionText {
  width: 100%;
  min-height: 120px;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 1em;
  font-family: inherit;
  resize: vertical;
  margin-bottom: 20px;
  transition: border-color 0.2s;
}

#descriptionText:focus {
  outline: none;
  border-color: #667eea;
}

.description-buttons {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.generate-btn {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1em;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s;
}

.generate-btn:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.generate-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.generate-btn.generating {
  background: #999;
}

.generate-btn.generating .generate-icon {
  animation: sparkle 1.5s infinite;
}

@keyframes sparkle {
  0%, 100% { transform: scale(1) rotate(0deg); }
  50% { transform: scale(1.2) rotate(180deg); }
}

.button-group {
  display: flex;
  gap: 10px;
}

.cancel-btn, .save-btn {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1em;
  transition: all 0.2s;
}

.cancel-btn {
  background: #f8f9fa;
  color: #666;
  border: 1px solid #e0e0e0;
}

.cancel-btn:hover {
  background: #e9ecef;
}

.save-btn {
  background: #28a745;
  color: white;
}

.save-btn:hover {
  background: #218838;
  transform: translateY(-1px);
}

</style>
{% endblock %}
{% block body %}
<div class="facet-header{% if facet_data.color %} has-color{% endif %}"{% if facet_data.color %} style="--facet-color: {{ facet_data.color }}"{% endif %}>
  <a href="{{ url_for('facets.facets_page') }}" class="back-button">← Back to Facets</a>

  <div class="facet-header-content">
    <div class="facet-header-left">
      {% if facet_data.emoji %}
      <div class="facet-emoji">{{ facet_data.emoji }}</div>
      {% endif %}
      <h1>{{ facet_data.title or facet_name }}</h1>
    </div>
    <div class="facet-header-right">
      <div class="agents-toggle">
        <span class="agents-toggle-label">Agents</span>
        <label class="toggle-switch">
          <input type="checkbox" id="agents-toggle-checkbox" {% if not facet_data.disabled %}checked{% endif %}>
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>
  </div>
</div>

<div class="tab-container">
  <div class="tab-nav">
    <button class="tab-button active" data-tab="description">Description</button>
    <a href="{{ url_for('facets.entity_manager', facet_name=facet_name) }}" class="tab-link">
      <span>Manage Entities</span>
      <svg class="gear-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="margin-left: 4px;">
        <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
        <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"/>
      </svg>
    </a>
    <a href="{{ url_for('facets.facet_day', facet_name=facet_name, day=today) }}" class="tab-link" title="View Calendar">
      <span>Calendar</span>
      <svg class="gear-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="margin-left: 4px;">
        <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/>
      </svg>
    </a>
  </div>

  <div id="description-tab" class="tab-content active">
    {% if facet_data.description %}
    <div class="description-content has-description">
      <p>{{ facet_data.description }}</p>
      <button class="btn btn-primary" onclick="openDescriptionEditor()">✏️ Edit Description</button>
    </div>
    {% else %}
    <div class="description-content no-description">
      <div class="placeholder">
        <h3>No description yet</h3>
        <p>Add a description to help explain what this facet is about.</p>
        <button class="btn btn-primary" onclick="openDescriptionEditor()">✨ Add Description</button>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Description Editor Modal -->
<div id="descriptionModal" class="description-modal">
  <div class="description-modal-content">
    <span class="description-close">&times;</span>
    <div class="description-modal-header">
      <h3 id="modal-title">Edit Facet Description</h3>
    </div>
    <div class="description-modal-body">
      <textarea id="descriptionText" placeholder="Enter facet description..."></textarea>
      <div class="description-buttons">
        <button id="generateBtn" class="generate-btn" title="Generate description with AI">
          <span class="generate-icon">✨</span>
          <span class="generate-text">Generate</span>
        </button>
        <div class="button-group">
          <button id="cancelBtn" class="cancel-btn">Cancel</button>
          <button id="saveBtn" class="save-btn">Save</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const facetName = '{{ facet_name }}';

// Description modal state
let currentDescriptionContext = 'facet'; // 'facet' for facet description

// Tab switching functionality (simplified for single tab)
document.addEventListener('DOMContentLoaded', function() {
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');

  function switchToTab(targetTab) {
    // Remove active class from all buttons and content
    tabButtons.forEach(btn => btn.classList.remove('active'));
    tabContents.forEach(content => content.classList.remove('active'));

    // Add active class to clicked button and corresponding content
    const targetButton = document.querySelector(`.tab-button[data-tab="${targetTab}"]`);
    if (targetButton) {
      targetButton.classList.add('active');
    }
    const targetContent = document.getElementById(targetTab + '-tab');
    if (targetContent) {
      targetContent.classList.add('active');
    }

    // Load data when tabs are activated
    if (targetTab === 'entities') {
      if (!entitiesData) {
        loadEntities();
      }
      // Auto-focus the search input when entities tab is opened
      setTimeout(() => {
        const searchInput = document.getElementById('entity-search');
        if (searchInput) {
          searchInput.focus();
        }
      }, 100);
    }
  }

  tabButtons.forEach(button => {
    button.addEventListener('click', function() {
      const targetTab = this.dataset.tab;

      // Update URL hash
      window.location.hash = targetTab;

      switchToTab(targetTab);
    });
  });

  // Check URL hash on page load and activate corresponding tab
  const hash = window.location.hash.substring(1); // Remove the '#'
  if (hash && document.querySelector(`.tab-button[data-tab="${hash}"]`)) {
    switchToTab(hash);
  }
});

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Description editor functionality
function openDescriptionEditor() {
  const modal = document.getElementById('descriptionModal');
  const textarea = document.getElementById('descriptionText');
  
  // Set current description
  const currentDesc = '{{ facet_data.description|replace("'", "\\'") }}' || '';
  textarea.value = currentDesc;
  
  modal.style.display = 'block';
  textarea.focus();
}

function closeDescriptionEditor() {
  document.getElementById('descriptionModal').style.display = 'none';
}

// Modal event listeners
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('descriptionModal');
  const closeBtn = document.querySelector('.description-close');
  const cancelBtn = document.getElementById('cancelBtn');
  const saveBtn = document.getElementById('saveBtn');
  const generateBtn = document.getElementById('generateBtn');
  
  // Close modal
  closeBtn.onclick = closeDescriptionEditor;
  cancelBtn.onclick = closeDescriptionEditor;
  
  // Click outside to close
  window.onclick = function(event) {
    if (event.target === modal) {
      closeDescriptionEditor();
    }
  };
  
  // Save description
  saveBtn.onclick = function() {
    const description = document.getElementById('descriptionText').value.trim();
    saveDescription(description);
  };
  
  // Generate description
  generateBtn.onclick = function() {
    generateDescription();
  };
});

function saveDescription(description) {
  const saveBtn = document.getElementById('saveBtn');
  const originalText = saveBtn.textContent;
  
  saveBtn.textContent = 'Saving...';
  saveBtn.disabled = true;
  
  fetch(`/api/facets/${encodeURIComponent(facetName)}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      description: description
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update the page description
      const descElement = document.querySelector('.description');
      if (description) {
        descElement.innerHTML = `${description} <span class="edit-description-btn" onclick="openDescriptionEditor()" title="Edit description">✨</span>`;
        descElement.classList.remove('no-description');
      } else {
        descElement.innerHTML = '<span class="add-description-text" onclick="openDescriptionEditor()">Add description...</span> <span class="edit-description-btn" onclick="openDescriptionEditor()" title="Add description">✨</span>';
        descElement.classList.add('no-description');
      }
      closeDescriptionEditor();
    } else {
      alert('Error saving description: ' + (data.error || 'Unknown error'));
    }
    
    saveBtn.textContent = originalText;
    saveBtn.disabled = false;
  })
  .catch(error => {
    console.error('Error saving description:', error);
    alert('Network error: ' + error.message);
    
    saveBtn.textContent = originalText;
    saveBtn.disabled = false;
  });
}

function generateDescription() {
  const generateBtn = document.getElementById('generateBtn');
  const textarea = document.getElementById('descriptionText');
  const generateIcon = generateBtn.querySelector('.generate-icon');
  const generateText = generateBtn.querySelector('.generate-text');

  // Update button state
  generateBtn.disabled = true;
  generateBtn.classList.add('generating');
  generateText.textContent = 'Generating...';

  const currentDescription = textarea.value.trim();

  fetch(`/api/facets/${encodeURIComponent(facetName)}/generate-description`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      current_description: currentDescription,
      facet_name: facetName
    })
  })
  .then(response => response.json())
  .then(data => {
    if (!data.success) {
      alert('Error generating description: ' + (data.error || 'Unknown error'));
      generateBtn.disabled = false;
      generateBtn.classList.remove('generating');
      generateText.textContent = 'Generate';
      return;
    }

    // Subscribe to events from the shared watcher
    const agentId = data.agent_id;

    const eventHandler = (event) => {
      // Only process events for our agent
      if (event.agent_id !== agentId) return;

      if (event.event === 'finish') {
        // Clean up description - strip whitespace
        let description = event.result || '';
        description = description.trim();

        textarea.value = description;
        textarea.focus();

        // Reset button state
        generateBtn.disabled = false;
        generateBtn.classList.remove('generating');
        generateText.textContent = 'Generate';
      } else if (event.event === 'error') {
        alert('Error generating description: ' + (event.error || 'Unknown error'));

        // Reset button state
        generateBtn.disabled = false;
        generateBtn.classList.remove('generating');
        generateText.textContent = 'Generate';
      }
    };

    // Listen for cortex events from our agent
    appEvents.listen('cortex', eventHandler);
  })
  .catch(error => {
    console.error('Error generating description:', error);
    alert('Network error: ' + error.message);

    // Reset button state
    generateBtn.disabled = false;
    generateBtn.classList.remove('generating');
    generateText.textContent = 'Generate';
  });
}

// Entity description editing
let currentEntityType = null;
let currentEntityName = null;

function openEntityDescriptionEditor(entityType, entityName, currentDescription) {
  currentEntityType = entityType;
  currentEntityName = entityName;
  
  const modal = document.getElementById('descriptionModal');
  const textarea = document.getElementById('descriptionText');
  const title = document.getElementById('modal-title');
  
  // Update modal title and content
  title.textContent = `Edit ${entityType}: ${entityName}`;
  textarea.placeholder = `Enter description for ${entityName}...`;
  textarea.value = currentDescription || '';
  
  modal.style.display = 'block';
  textarea.focus();
}

// Override save function to handle both facet and entity descriptions
function saveDescription(description) {
  const saveBtn = document.getElementById('saveBtn');
  const originalText = saveBtn.textContent;
  
  saveBtn.textContent = 'Saving...';
  saveBtn.disabled = true;
  
  // Determine if we're editing facet or entity description
  if (currentEntityType && currentEntityName) {
    // Save entity description
    saveEntityDescription(description);
  } else {
    // Save facet description (original functionality)
    saveFacetDescription(description);
  }
}

function saveFacetDescription(description) {
  const saveBtn = document.getElementById('saveBtn');
  
  fetch(`/api/facets/${encodeURIComponent(facetName)}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      description: description
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update the description tab content
      const descContent = document.querySelector('.description-content');
      if (description) {
        descContent.innerHTML = `<p>${description}</p><button class="btn btn-primary" onclick="openDescriptionEditor()">✏️ Edit Description</button>`;
        descContent.classList.remove('no-description');
        descContent.classList.add('has-description');
      } else {
        descContent.innerHTML = `
          <div class="placeholder">
            <h3>No description yet</h3>
            <p>Add a description to help explain what this facet is about.</p>
            <button class="btn btn-primary" onclick="openDescriptionEditor()">✨ Add Description</button>
          </div>
        `;
        descContent.classList.add('no-description');
        descContent.classList.remove('has-description');
      }
      closeDescriptionEditor();
    } else {
      alert('Error saving description: ' + (data.error || 'Unknown error'));
    }
    
    saveBtn.textContent = 'Save';
    saveBtn.disabled = false;
  })
  .catch(error => {
    console.error('Error saving description:', error);
    alert('Network error: ' + error.message);
    
    saveBtn.textContent = 'Save';
    saveBtn.disabled = false;
  });
}

function saveEntityDescription(description) {
  const saveBtn = document.getElementById('saveBtn');
  
  fetch(`/api/facets/${encodeURIComponent(facetName)}/entities/description`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      type: currentEntityType,
      name: currentEntityName,
      description: description
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update the entity in our local data
      if (entitiesData && entitiesData.all_entities) {
        const entity = entitiesData.all_entities.find(e => 
          e.type === currentEntityType && e.name === currentEntityName
        );
        if (entity) {
          entity.desc = description;
        }
      }
      
      // Get current search term to maintain filter
      const searchInput = document.getElementById('entity-search');
      const currentSearchTerm = searchInput ? searchInput.value.trim() : '';
      
      // Re-render the entities tables with current search filter
      renderEntities(currentSearchTerm);
      closeDescriptionEditor();
    } else {
      alert('Error saving entity description: ' + (data.error || 'Unknown error'));
    }
    
    saveBtn.textContent = 'Save';
    saveBtn.disabled = false;
  })
  .catch(error => {
    console.error('Error saving entity description:', error);
    alert('Network error: ' + error.message);
    
    saveBtn.textContent = 'Save';
    saveBtn.disabled = false;
  });
}

// Override generate function to handle both facet and entity descriptions
function generateDescription() {
  const generateBtn = document.getElementById('generateBtn');
  const textarea = document.getElementById('descriptionText');
  const generateIcon = generateBtn.querySelector('.generate-icon');
  const generateText = generateBtn.querySelector('.generate-text');
  
  // Update button state
  generateBtn.disabled = true;
  generateBtn.classList.add('generating');
  generateText.textContent = 'Generating...';
  
  const currentDescription = textarea.value.trim();
  
  // Determine API endpoint and payload
  let apiUrl, payload;
  
  if (currentEntityType && currentEntityName) {
    // Generate entity description
    apiUrl = `/api/facets/${encodeURIComponent(facetName)}/entities/generate-description`;
    payload = {
      type: currentEntityType,
      name: currentEntityName,
      current_description: currentDescription
    };
  } else {
    // Generate facet description (original functionality)
    apiUrl = `/api/facets/${encodeURIComponent(facetName)}/generate-description`;
    payload = {
      current_description: currentDescription,
      facet_name: facetName
    };
  }
  
  fetch(apiUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(payload)
  })
  .then(response => response.json())
  .then(data => {
    if (!data.success) {
      alert('Error generating description: ' + (data.error || 'Unknown error'));
      generateBtn.disabled = false;
      generateBtn.classList.remove('generating');
      generateText.textContent = 'Generate';
      return;
    }

    // Subscribe to events from the shared watcher
    const agentId = data.agent_id;

    const eventHandler = (event) => {
      // Only process events for our agent
      if (event.agent_id !== agentId) return;

      if (event.event === 'finish') {
        // Clean up description - strip whitespace
        let description = event.result || '';
        description = description.trim();

        textarea.value = description;
        textarea.focus();

        // Reset button state
        generateBtn.disabled = false;
        generateBtn.classList.remove('generating');
        generateText.textContent = 'Generate';
      } else if (event.event === 'error') {
        alert('Error generating description: ' + (event.error || 'Unknown error'));

        // Reset button state
        generateBtn.disabled = false;
        generateBtn.classList.remove('generating');
        generateText.textContent = 'Generate';
      }
    };

    // Listen for cortex events from our agent
    appEvents.listen('cortex', eventHandler);
  })
  .catch(error => {
    console.error('Error generating description:', error);
    alert('Network error: ' + error.message);

    // Reset button state
    generateBtn.disabled = false;
    generateBtn.classList.remove('generating');
    generateText.textContent = 'Generate';
  });
}

// Reset entity editing state when modal closes
function closeDescriptionEditor() {
  currentEntityType = null;
  currentEntityName = null;
  document.getElementById('modal-title').textContent = 'Edit Facet Description';
  document.getElementById('descriptionText').placeholder = 'Enter facet description...';
  document.getElementById('descriptionModal').style.display = 'none';
}

// Entity assistant inline add functionality
let entityAssistAgentId = null;

function openEntityAssistInput() {
  const tbody = document.getElementById('facet-entities-tbody');

  // Check if input row already exists
  if (document.querySelector('.entity-input-row')) {
    return;
  }

  // Create input row
  const inputRow = document.createElement('tr');
  inputRow.className = 'entity-input-row';

  const inputCell = document.createElement('td');
  inputCell.colSpan = 4;

  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = "Enter their name and we'll figure out the rest...";
  input.id = 'entity-assist-input';

  // Handle keyboard events
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      // Cancel - remove the input row
      inputRow.remove();

      // Show the no entities message if no entities
      const tbody = document.getElementById('facet-entities-tbody');
      if (tbody.children.length === 0) {
        document.getElementById('no-facet-entities').style.display = 'block';
        document.getElementById('facet-entities-section').querySelector('table').style.display = 'none';
      }
    } else if (e.key === 'Enter') {
      e.preventDefault();
      const name = input.value.trim();
      if (name) {
        submitEntityAssist(name);
      }
    }
  });

  inputCell.appendChild(input);
  inputRow.appendChild(inputCell);

  // Insert as first row
  tbody.insertBefore(inputRow, tbody.firstChild);

  // Show table if hidden
  const table = document.getElementById('facet-entities-section').querySelector('table');
  table.style.display = 'table';
  document.getElementById('no-facet-entities').style.display = 'none';

  // Focus the input
  input.focus();
}

function submitEntityAssist(name) {
  const inputRow = document.querySelector('.entity-input-row');
  if (!inputRow) return;

  // Remove input row
  inputRow.remove();

  // Create generating row
  const generatingRow = document.createElement('tr');
  generatingRow.className = 'entity-generating-row';
  generatingRow.id = 'entity-assist-generating-row';

  // Empty cell for star button column
  const starCell = document.createElement('td');
  generatingRow.appendChild(starCell);

  // Empty cell for type column
  const typeCell = document.createElement('td');
  typeCell.className = 'entity-type';
  generatingRow.appendChild(typeCell);

  // Name cell
  const nameCell = document.createElement('td');
  nameCell.className = 'entity-name';
  nameCell.textContent = escapeHtml(name);
  generatingRow.appendChild(nameCell);

  // Description cell with generating text
  const descCell = document.createElement('td');
  descCell.className = 'entity-desc';
  descCell.innerHTML = 'Generating<span class="generating-dots"></span>';
  generatingRow.appendChild(descCell);

  // Insert as first row
  const tbody = document.getElementById('facet-entities-tbody');
  tbody.insertBefore(generatingRow, tbody.firstChild);

  // Submit to backend
  fetch(`/api/facets/${encodeURIComponent(facetName)}/entities/assist`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ name: name })
  })
  .then(response => response.json())
  .then(data => {
    if (!data.success) {
      alert('Error starting entity assistant: ' + (data.error || 'Unknown error'));
      // Remove generating row on error
      const genRow = document.getElementById('entity-assist-generating-row');
      if (genRow) genRow.remove();
      return;
    }

    // Store agent ID for event filtering
    entityAssistAgentId = data.agent_id;
  })
  .catch(error => {
    console.error('Error starting entity assistant:', error);
    alert('Network error: ' + error.message);
    // Remove generating row on error
    const genRow = document.getElementById('entity-assist-generating-row');
    if (genRow) genRow.remove();
  });
}

// Listen for entity assist completion events
appEvents.listen('cortex', function(event) {
  // Only process events for our entity assist agent
  if (!entityAssistAgentId || event.agent_id !== entityAssistAgentId) return;

  if (event.event === 'finish') {
    // Clear the agent ID
    entityAssistAgentId = null;

    // Refresh the page to show the new entity
    location.reload();
  } else if (event.event === 'error') {
    // Clear the agent ID
    entityAssistAgentId = null;

    // Remove the generating row
    const genRow = document.getElementById('entity-assist-generating-row');
    if (genRow) genRow.remove();

    // Show error message
    const errorMsg = event.error || 'Unknown error occurred';
    alert('Error creating entity: ' + errorMsg);
  }
});

// Entity deletion functionality
let entityToDelete = null;

function previewEntityDelete(entityName) {
  entityToDelete = entityName;

  const modal = document.getElementById('deleteModal');
  const nameEl = document.getElementById('deleteEntityName');
  const loadingEl = document.getElementById('deleteLoadingMsg');
  const daysContainer = document.getElementById('deleteDaysContainer');
  const confirmBtn = document.getElementById('confirmDeleteBtn');

  // Set entity name
  nameEl.textContent = entityName;

  // Show loading state
  loadingEl.style.display = 'block';
  daysContainer.style.display = 'none';
  confirmBtn.disabled = true;

  // Show modal
  modal.style.display = 'block';

  // Fetch preview
  fetch(`/api/facets/${encodeURIComponent(facetName)}/entities/detected/preview?name=${encodeURIComponent(entityName)}`)
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        throw new Error(data.error);
      }

      const days = data.days || [];

      if (days.length === 0) {
        loadingEl.innerHTML = '<p style="color: #999;">Entity not found in any detected day files.</p>';
        confirmBtn.disabled = true;
        return;
      }

      // Hide loading, show days list
      loadingEl.style.display = 'none';
      daysContainer.style.display = 'block';
      confirmBtn.disabled = false;

      // Update count
      const countText = days.length === 1 ? '1 day' : `${days.length} days`;
      document.getElementById('deleteDaysCount').textContent = countText;

      // Render days list
      const daysList = document.getElementById('deleteDaysList');
      daysList.innerHTML = '';

      days.forEach(day => {
        const dayItem = document.createElement('div');
        dayItem.className = 'delete-day-item';

        const dateStr = formatDayKey(day.day);
        const typeStr = day.type ? ` (${day.type})` : '';

        dayItem.innerHTML = `
          <span class="delete-day-date">${dateStr}</span>
          <span class="delete-day-type">${typeStr}</span>
        `;

        daysList.appendChild(dayItem);
      });
    })
    .catch(error => {
      console.error('Error previewing entity deletion:', error);
      loadingEl.innerHTML = `<p style="color: #c33;">Error: ${escapeHtml(error.message)}</p>`;
      confirmBtn.disabled = true;
    });
}

function closeDeleteModal() {
  const modal = document.getElementById('deleteModal');
  const confirmBtn = document.getElementById('confirmDeleteBtn');

  modal.style.display = 'none';
  entityToDelete = null;

  // Reset button state
  confirmBtn.disabled = false;
  confirmBtn.textContent = 'Delete';
}

function confirmEntityDelete() {
  if (!entityToDelete) {
    return;
  }

  const confirmBtn = document.getElementById('confirmDeleteBtn');
  const originalText = confirmBtn.textContent;

  confirmBtn.disabled = true;
  confirmBtn.textContent = 'Deleting...';

  fetch(`/api/facets/${encodeURIComponent(facetName)}/entities/detected`, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      name: entityToDelete
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      throw new Error(data.error);
    }

    // Close modal
    closeDeleteModal();

    // Remove entity from local data and re-render
    if (entitiesData && entitiesData.all_entities) {
      entitiesData.all_entities = entitiesData.all_entities.filter(
        e => e.name !== entityToDelete
      );

      // Get current search term to maintain filter
      const searchInput = document.getElementById('entity-search');
      const currentSearchTerm = searchInput ? searchInput.value.trim() : '';

      // Re-render with current search filter
      renderEntities(currentSearchTerm);
    }
  })
  .catch(error => {
    console.error('Error deleting entity:', error);
    alert('Error deleting entity: ' + error.message);

    confirmBtn.disabled = false;
    confirmBtn.textContent = originalText;
  });
}

function formatDayKey(dayKey) {
  if (!dayKey || typeof dayKey !== 'string' || dayKey.length !== 8) {
    return dayKey || 'Unknown date';
  }

  const year = Number(dayKey.slice(0, 4));
  const month = Number(dayKey.slice(4, 6)) - 1;
  const day = Number(dayKey.slice(6, 8));

  const dateObj = new Date(year, month, day);
  if (Number.isNaN(dateObj.getTime())) {
    return dayKey;
  }

  return dateObj.toLocaleDateString(undefined, {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}

// Agents toggle functionality
document.addEventListener('DOMContentLoaded', function() {
  const agentsToggle = document.getElementById('agents-toggle-checkbox');

  if (agentsToggle) {
    agentsToggle.addEventListener('change', function() {
      const isEnabled = this.checked;

      // Disable toggle during request
      this.disabled = true;

      fetch(`/api/facets/${encodeURIComponent(facetName)}/toggle`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Toggle successful
          console.log(`Facet agents ${isEnabled ? 'enabled' : 'disabled'}`);
        } else {
          // Revert toggle on error
          this.checked = !isEnabled;
          alert('Error toggling agents: ' + (data.error || 'Unknown error'));
        }

        // Re-enable toggle
        this.disabled = false;
      })
      .catch(error => {
        console.error('Error toggling agents:', error);
        // Revert toggle on error
        this.checked = !isEnabled;
        alert('Network error: ' + error.message);

        // Re-enable toggle
        this.disabled = false;
      });
    });
  }
});

// Close delete modal when clicking outside
window.addEventListener('click', function(event) {
  const modal = document.getElementById('deleteModal');
  if (event.target === modal) {
    closeDeleteModal();
  }
});

// Entity Edit Modal functionality
let currentEditEntity = null;

function openEntityEditModal(entityType, entityName, entityAkas) {
  currentEditEntity = { type: entityType, name: entityName };

  const modal = document.getElementById('entityEditModal');
  const nameInput = document.getElementById('entityEditName');
  const akasInput = document.getElementById('entityEditAkas');
  const errorContainer = document.getElementById('entityEditError');

  // Clear any previous errors
  errorContainer.innerHTML = '';

  // Populate form
  nameInput.value = entityName;
  akasInput.value = Array.isArray(entityAkas) ? entityAkas.join(', ') : (entityAkas || '');

  // Show modal
  modal.style.display = 'block';
  nameInput.focus();
}

function closeEntityEditModal() {
  const modal = document.getElementById('entityEditModal');
  modal.style.display = 'none';
  currentEditEntity = null;
}

// Handle entity edit form submission
document.addEventListener('DOMContentLoaded', function() {
  const entityEditForm = document.getElementById('entityEditForm');
  const entityEditModal = document.getElementById('entityEditModal');

  if (entityEditForm) {
    entityEditForm.addEventListener('submit', function(e) {
      e.preventDefault();
      saveEntityEdit();
    });
  }

  // Close modal when clicking outside
  if (entityEditModal) {
    window.addEventListener('click', function(event) {
      if (event.target === entityEditModal) {
        closeEntityEditModal();
      }
    });
  }
});

function saveEntityEdit() {
  if (!currentEditEntity) return;

  const saveBtn = document.getElementById('entityEditSaveBtn');
  const errorContainer = document.getElementById('entityEditError');
  const newName = document.getElementById('entityEditName').value.trim();
  const akaList = document.getElementById('entityEditAkas').value.trim();

  if (!newName) {
    errorContainer.innerHTML = '<div class="error-message">Name is required</div>';
    return;
  }

  // Clear errors
  errorContainer.innerHTML = '';

  // Update button state
  saveBtn.disabled = true;
  saveBtn.textContent = 'Saving...';

  fetch(`/api/facets/${encodeURIComponent(facetName)}/entities/update`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      type: currentEditEntity.type,
      old_name: currentEditEntity.name,
      new_name: newName,
      aka_list: akaList
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update the entity in our local data
      if (entitiesData && entitiesData.all_entities) {
        const entity = entitiesData.all_entities.find(e =>
          e.type === currentEditEntity.type && e.name === currentEditEntity.name
        );
        if (entity) {
          entity.name = newName;
          entity.aka = data.entity.aka || [];
        }
      }

      // Get current search term to maintain filter
      const searchInput = document.getElementById('entity-search');
      const currentSearchTerm = searchInput ? searchInput.value.trim() : '';

      // Re-render entities
      renderEntities(currentSearchTerm);
      closeEntityEditModal();
    } else {
      errorContainer.innerHTML = `<div class="error-message">${escapeHtml(data.error || 'Unknown error')}</div>`;
    }

    saveBtn.disabled = false;
    saveBtn.textContent = 'Save';
  })
  .catch(error => {
    console.error('Error saving entity:', error);
    errorContainer.innerHTML = `<div class="error-message">Network error: ${escapeHtml(error.message)}</div>`;

    saveBtn.disabled = false;
    saveBtn.textContent = 'Save';
  });
}
</script>
{% endblock %}
