{% extends 'base.html' %}
{% set title = 'Calendar' %}
{% set active = 'calendar' %}
{% block head %}
<style>
body { margin-top: 60px; }
.container { padding: 0 1em; }
h1 { margin-bottom: 0.5em; }

/* Facet Chooser */
#facetChooser {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: white;
  border-bottom: 1px solid #e0e0e0;
  z-index: 1000;
  padding: 12px 16px;
  padding-left: 70px;
  overflow-x: auto;
  overflow-y: hidden;
  white-space: nowrap;
  scrollbar-width: thin;
  text-align: center;
  transition: background-color 0.3s ease;
}
#facetChooser::-webkit-scrollbar {
  height: 6px;
}
#facetChooser::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 3px;
}
.facet-pill {
  display: inline-block;
  padding: 8px 16px;
  margin-right: 8px;
  border-radius: 20px;
  background: #f5f5f5;
  border: 1px solid #ddd;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
  user-select: none;
}
.facet-pill:hover {
  border-color: #999;
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.facet-pill.selected {
  border-color: #007bff;
  font-weight: 500;
  box-shadow: 0 2px 6px rgba(0,123,255,0.2);
}
.facet-pill .emoji {
  margin-right: 6px;
}

#controls { display: flex; align-items: center; margin-bottom: 1em; gap: 6px; }
#controls button { background:#007bff; color:white; border:none; padding:6px 12px; margin:0 6px; border-radius:4px; cursor:pointer; }
#controls span { font-size:1.2em; font-weight:bold; }
#calendar { width:100%; border-collapse:collapse; }
#calendar th, #calendar td { width:14.28%; border:1px solid #e0e0e0; vertical-align:top; height:90px; padding:4px; position:relative; }
#calendar th { background:#f8f9fa; }
#calendar td.today { background:rgba(0,123,255,0.12); box-shadow:inset 0 0 0 2px #007bff; }
.day-number { font-weight:bold; text-decoration:none; color:inherit; display:inline-block; }
.missing { color:#ccc; }
/* Activity level backgrounds for past days */
.activity-high { background:rgba(0,123,255,0.08); }  /* Light blue */
.activity-medium { background:rgba(40,167,69,0.08); }  /* Light green */
.activity-low { background:rgba(255,193,7,0.08); }  /* Light yellow */
.activity-none { background:rgba(220,53,69,0.08); }  /* Light red */
.day-actions {
  position:absolute;
  bottom:4px;
  left:4px;
  right:4px;
  display:flex;
  gap:3px;
  justify-content:flex-start;
}
.day-actions a {
  text-decoration:none;
  font-size:18px;
  padding:2px;
  opacity:0.7;
  transition:opacity 0.2s;
}
.day-actions a:hover {
  opacity:1;
}
</style>
{% endblock %}
{% block body %}
<div id="facetChooser"></div>
<div class="container">
  <div id="controls">
    <button id="prevMonth">&#8592;</button>
    <span id="monthLabel"></span>
    <button id="nextMonth">&#8594;</button>
    <button id="todayBtn" style="margin-left:auto;">Today</button>
  </div>
  <table id="calendar">
    <thead>
      <tr><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
let dayStats = {};
let availableDays = new Set();
const dayBase = '{{ url_for("calendar.calendar_day", day="") }}';
const todosBase = '{{ url_for("todos.todos_day", day="") }}';
let months = [];
let currentIndex = 0;
const now = new Date();
const CURRENT_YEAR_MONTH = generateYearMonth(now.getFullYear(), now.getMonth());
const TODAY_DATE_STRING = CURRENT_YEAR_MONTH + String(now.getDate()).padStart(2,'0');

// Facet filtering state
let activeFacets = [];
let selectedFacet = null; // null means "All"

// Parse URL fragment to get initial facet selection
function getSelectedFacetFromHash() {
  const hash = window.location.hash;
  if (hash.startsWith('#facet-')) {
    return hash.substring(7); // Remove '#facet-' prefix
  }
  return null;
}

// Update URL hash when facet selection changes
function updateFacetHash(facet) {
  if (facet) {
    window.location.hash = `facet-${facet}`;
  } else {
    window.location.hash = '';
  }
}

// Convert hex color to rgba with opacity
function hexToRgba(hex, alpha) {
  if (!hex || hex.length < 6) return `rgba(128,128,128,${alpha})`;
  const r = parseInt(hex.substring(1,3), 16);
  const g = parseInt(hex.substring(3,5), 16);
  const b = parseInt(hex.substring(5,7), 16);
  return `rgba(${r},${g},${b},${alpha})`;
}

// Load facets and render chooser
function loadFacetChooser() {
  fetch('{{ url_for("calendar.calendar_active_facets") }}')
    .then(r => r.json())
    .then(facets => {
      activeFacets = facets;
      renderFacetChooser();
    })
    .catch(err => {
      console.error('Failed to load facets:', err);
    });
}

// Render facet pills
function renderFacetChooser() {
  const chooser = document.getElementById('facetChooser');
  chooser.innerHTML = '';

  // Find selected facet data
  const selectedFacetData = selectedFacet ? activeFacets.find(f => f.name === selectedFacet) : null;

  // Apply tray background color based on selected facet
  if (selectedFacetData && selectedFacetData.color) {
    chooser.style.background = hexToRgba(selectedFacetData.color, 0.1);
    chooser.style.borderBottomColor = selectedFacetData.color;
  } else {
    chooser.style.background = 'white';
    chooser.style.borderBottomColor = '#e0e0e0';
  }

  // "All" pill
  const allPill = document.createElement('div');
  allPill.className = 'facet-pill' + (selectedFacet === null ? ' selected' : '');
  allPill.textContent = 'All';
  allPill.onclick = () => selectFacet(null);
  chooser.appendChild(allPill);

  // Facet pills
  activeFacets.forEach(facet => {
    const pill = document.createElement('div');
    pill.className = 'facet-pill' + (selectedFacet === facet.name ? ' selected' : '');

    if (facet.emoji) {
      const emoji = document.createElement('span');
      emoji.className = 'emoji';
      emoji.textContent = facet.emoji;
      pill.appendChild(emoji);
    }

    const title = document.createElement('span');
    title.textContent = facet.title;
    pill.appendChild(title);

    // Apply color with opacity if facet is selected and has a color
    if (selectedFacet === facet.name && facet.color) {
      pill.style.background = hexToRgba(facet.color, 0.2);
      pill.style.borderColor = facet.color;
    }

    pill.onclick = () => selectFacet(facet.name);
    chooser.appendChild(pill);
  });
}

// Handle facet selection
function selectFacet(facet) {
  selectedFacet = facet;
  updateFacetHash(facet);
  renderFacetChooser();
  loadData();
}

// Listen for hash changes (browser back/forward)
window.addEventListener('hashchange', () => {
  const facet = getSelectedFacetFromHash();
  if (facet !== selectedFacet) {
    selectedFacet = facet;
    renderFacetChooser();
    loadData();
  }
});

function loadData() {
  // Build stats URL with facet filter if selected
  let statsUrl = '{{ url_for("calendar.calendar_stats") }}';
  if (selectedFacet) {
    statsUrl += `?facet=${encodeURIComponent(selectedFacet)}`;
  }

  const statsReq = fetch(statsUrl).then(r => {
    if (!r.ok) throw new Error('Failed to fetch stats');
    return r.json();
  });
  const daysReq = fetch('{{ url_for("calendar.calendar_days") }}').then(r => {
    if (!r.ok) throw new Error('Failed to fetch days');
    return r.json();
  });
  Promise.all([statsReq, daysReq])
    .then(([stats, days]) => {
      dayStats = stats || {};
      availableDays = new Set(days || []);
      const monthSet = new Set(Array.from(availableDays).map(d => d.slice(0,6)));
      monthSet.add(CURRENT_YEAR_MONTH);
      months = Array.from(monthSet).sort();
      currentIndex = months.indexOf(CURRENT_YEAR_MONTH);
      if (currentIndex === -1) {
        currentIndex = months.length - 1;
      }
      showMonth(months[currentIndex]);
    })
    .catch(err => {
      console.error('Error loading calendar data:', err);
      months = [CURRENT_YEAR_MONTH];
      currentIndex = 0;
      showMonth(months[currentIndex]);
    });
}

function createDayContent(dateStr, day) {
  const stats = dayStats[dateStr];
  const exists = availableDays.has(dateStr);

  let html = '';

  // Day number
  if (exists) {
    html += `<a class='day-number' href='${dayBase}${dateStr}'>${day}</a>`;
  } else {
    html += `<span class='day-number missing'>${day}</span>`;
  }

  // Action icons
  if (exists && stats) {
    html += `<div class='day-actions'>`;

    // Note/Topics icon - only if topics exist
    if (stats.has_topics) {
      html += `<a href='${dayBase}${dateStr}' title='Day Notes'>üìù</a>`;
    }

    // Todos icon - only if todos exist
    if (stats.has_todos) {
      html += `<a href='${todosBase}${dateStr}' title='Todos'>‚úÖ</a>`;
    }

    // Transcript icon - only if transcripts exist
    if (stats.has_transcripts) {
      html += `<a href='${dayBase}${dateStr}/transcript' title='Transcript'>üí¨</a>`;
    }

    html += `</div>`;
  }

  return html;
}

function showMonth(ym) {
  const year = parseInt(ym.slice(0,4));
  const month = parseInt(ym.slice(4)) - 1;
  const first = new Date(year, month, 1);
  document.getElementById('monthLabel').textContent = first.toLocaleString('default',{month:'long', year:'numeric'});

  // Show/hide Today button based on current month
  const todayBtn = document.getElementById('todayBtn');
  if (ym === CURRENT_YEAR_MONTH) {
    todayBtn.style.display = 'none';
  } else {
    todayBtn.style.display = 'block';
  }

  const tbody = document.querySelector('#calendar tbody');
  tbody.innerHTML='';
  const startDay = first.getDay();
  const daysInMonth = new Date(year, month+1, 0).getDate();
  let row = document.createElement('tr');

  // Empty cells for days before month starts
  for(let i=0; i<startDay; i++){
    row.appendChild(document.createElement('td'));
  }

  // Days of the month
  for(let day=1; day<=daysInMonth; day++){
    if((startDay+day-1)%7===0 && day!==1){
      tbody.appendChild(row);
      row=document.createElement('tr');
    }
    const td = document.createElement('td');
    const dateStr = ym + String(day).padStart(2,'0');
    const isPastDay = dateStr < TODAY_DATE_STRING;

    td.innerHTML = createDayContent(dateStr, day);

    // Apply activity level background for past days
    if (isPastDay) {
      const stats = dayStats[dateStr];
      const exists = availableDays.has(dateStr);
      if (!exists) {
        td.classList.add('activity-none');
      } else if (stats && stats.activity_level) {
        td.classList.add('activity-' + stats.activity_level);
      }
    }

    if (dateStr === TODAY_DATE_STRING) {
      td.classList.add('today');
    }

    row.appendChild(td);
  }

  // Fill remaining cells in last row
  while(row.children.length<7){
    row.appendChild(document.createElement('td'));
  }
  tbody.appendChild(row);
}


function generateYearMonth(year, month) {
  return year + String(month + 1).padStart(2, '0');
}

function navigateMonth(direction) {
  const newIndex = currentIndex + direction;
  
  if (newIndex >= 0 && newIndex < months.length) {
    currentIndex = newIndex;
    showMonth(months[currentIndex]);
    return;
  }
  
  // Generate new month if at boundaries
  const isNext = direction > 0;
  const referenceYm = months[isNext ? months.length - 1 : 0];
  const year = parseInt(referenceYm.slice(0,4));
  const month = parseInt(referenceYm.slice(4)) - 1;
  const newDate = new Date(year, month + direction, 1);
  const newYm = generateYearMonth(newDate.getFullYear(), newDate.getMonth());
  
  if (isNext) {
    months.push(newYm);
    currentIndex = months.length - 1;
  } else {
    months.unshift(newYm);
    currentIndex = 0;
  }
  showMonth(months[currentIndex]);
}


document.getElementById('prevMonth').onclick = () => navigateMonth(-1);
document.getElementById('nextMonth').onclick = () => navigateMonth(1);
document.getElementById('todayBtn').onclick = () => {
  currentIndex = months.indexOf(CURRENT_YEAR_MONTH);
  if (currentIndex === -1) {
    // If current month not in list, add it
    months.push(CURRENT_YEAR_MONTH);
    months.sort();
    currentIndex = months.indexOf(CURRENT_YEAR_MONTH);
  }
  showMonth(CURRENT_YEAR_MONTH);
};

// Initialize facet selection from URL hash
selectedFacet = getSelectedFacetFromHash();

// Load facet chooser and calendar data
loadFacetChooser();
loadData();
</script>
{% endblock %}
