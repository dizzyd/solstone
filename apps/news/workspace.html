<style>
/* News feed styles */
.news-container {
  max-width: 900px;
  margin: 0 auto;
  padding: 2em;
}

.news-loading {
  text-align: center;
  padding: 4em;
  color: #666;
}

.spinner {
  display: inline-block;
  width: 40px;
  height: 40px;
  border: 4px solid #f0f0f0;
  border-top-color: #667eea;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 1em;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.news-empty {
  text-align: center;
  padding: 4em;
  color: #999;
}

.news-sections {
  display: flex;
  flex-direction: column;
  gap: 2.5em;
}

.news-section {
  background: white;
  border-radius: 12px;
  padding: 1.5em;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  border: 1px solid #eef2ff;
}

.news-section-header {
  font-size: 1.3em;
  font-weight: 600;
  color: #333;
  margin: 0 0 1em 0;
  padding-bottom: 0.5em;
  border-bottom: 2px solid #eef2ff;
  display: flex;
  align-items: center;
  gap: 0.5em;
}

.news-section-header .facet-emoji {
  font-size: 1.2em;
}

.newsletter-content {
  line-height: 1.6;
  color: #444;
}

/* Markdown styling */
.newsletter-content h1 {
  font-size: 1.8em;
  margin: 1em 0 0.5em 0;
  color: #333;
}

.newsletter-content h2 {
  font-size: 1.4em;
  margin: 1em 0 0.5em 0;
  color: #444;
  border-bottom: 1px solid #eee;
  padding-bottom: 0.25em;
}

.newsletter-content h3 {
  font-size: 1.2em;
  margin: 0.8em 0 0.4em 0;
  color: #555;
}

.newsletter-content p {
  margin: 0.8em 0;
}

.newsletter-content ul,
.newsletter-content ol {
  margin: 0.8em 0;
  padding-left: 1.5em;
}

.newsletter-content li {
  margin: 0.4em 0;
}

.newsletter-content blockquote {
  background: #f9f9fa;
  border-left: 4px solid #667eea;
  padding: 0.8em 1em;
  margin: 1em 0;
  color: #555;
}

.newsletter-content code {
  background: #f4f4f5;
  padding: 0.2em 0.4em;
  border-radius: 3px;
  font-family: 'Courier New', monospace;
  font-size: 0.9em;
}

.newsletter-content pre {
  background: #f4f4f5;
  padding: 1em;
  border-radius: 6px;
  overflow-x: auto;
  margin: 1em 0;
}

.newsletter-content pre code {
  background: none;
  padding: 0;
}

.newsletter-content strong {
  font-weight: 600;
  color: #333;
}

.newsletter-content em {
  font-style: italic;
}

.newsletter-content a {
  color: #667eea;
  text-decoration: none;
  border-bottom: 1px solid transparent;
  transition: border-color 0.2s;
}

.newsletter-content a:hover {
  border-bottom-color: #667eea;
}
</style>

<div class="news-container">
  <div id="news-loading" class="news-loading">
    <div class="spinner"></div>
    <p>Loading newsletters...</p>
  </div>

  <div id="news-content" style="display: none;">
    <div id="news-empty" class="news-empty" style="display: none;">
      <p>No newsletters for this day.</p>
    </div>

    <div class="news-sections" id="news-sections"></div>
  </div>
</div>

<script src="{{ vendor_lib('marked') }}"></script>
<script>
(function() {
  // Get day from template context
  const currentDay = '{{ day }}';
  let currentFacet = window.selectedFacet;
  let newsLoading = false;

  // Listen for facet changes
  window.addEventListener('facet.switch', (e) => {
    currentFacet = e.detail.facet;
    loadNews();
  });

  function loadNews() {
    if (newsLoading) return;
    newsLoading = true;

    const loadingEl = document.getElementById('news-loading');
    const contentEl = document.getElementById('news-content');
    const sectionsEl = document.getElementById('news-sections');
    const emptyEl = document.getElementById('news-empty');

    loadingEl.style.display = 'block';
    contentEl.style.display = 'none';
    sectionsEl.innerHTML = '';

    if (currentFacet) {
      // Load news for specific facet
      fetchFacetNews(currentFacet)
        .then(result => {
          loadingEl.style.display = 'none';
          contentEl.style.display = 'block';

          if (result && result.content) {
            emptyEl.style.display = 'none';
            appendNewsSection(result.facet, result.facetData, result.content);
          } else {
            emptyEl.style.display = 'block';
          }
          newsLoading = false;
        })
        .catch(error => {
          console.error('Error loading news:', error);
          loadingEl.innerHTML = `<p style="color: #c33;">Error: ${error.message}</p>`;
          newsLoading = false;
        });
    } else {
      // Load news for all facets
      const facets = window.facetsData || [];
      if (facets.length === 0) {
        loadingEl.style.display = 'none';
        contentEl.style.display = 'block';
        emptyEl.style.display = 'block';
        newsLoading = false;
        return;
      }

      // Fetch all facets in parallel
      Promise.all(facets.map(f => fetchFacetNews(f.name)))
        .then(results => {
          loadingEl.style.display = 'none';
          contentEl.style.display = 'block';

          // Filter to facets that have content
          const withContent = results.filter(r => r && r.content);

          if (withContent.length === 0) {
            emptyEl.style.display = 'block';
          } else {
            emptyEl.style.display = 'none';
            withContent.forEach(result => {
              appendNewsSection(result.facet, result.facetData, result.content);
            });
          }
          newsLoading = false;
        })
        .catch(error => {
          console.error('Error loading news:', error);
          loadingEl.innerHTML = `<p style="color: #c33;">Error: ${error.message}</p>`;
          newsLoading = false;
        });
    }
  }

  function fetchFacetNews(facetName) {
    const facetData = (window.facetsData || []).find(f => f.name === facetName);

    return fetch(`/app/news/api/${encodeURIComponent(facetName)}?day=${currentDay}`)
      .then(response => response.json())
      .then(data => {
        if (data.error) throw new Error(data.error);

        const days = data.days || [];
        if (days.length === 0 || !days[0].raw_content) {
          return { facet: facetName, facetData, content: null };
        }

        return {
          facet: facetName,
          facetData,
          content: days[0].raw_content
        };
      });
  }

  function appendNewsSection(facetName, facetData, content) {
    const container = document.getElementById('news-sections');

    const section = document.createElement('section');
    section.className = 'news-section';

    // Header with facet info (only show in all-facet mode)
    if (!currentFacet && facetData) {
      const header = document.createElement('h3');
      header.className = 'news-section-header';

      if (facetData.emoji) {
        const emoji = document.createElement('span');
        emoji.className = 'facet-emoji';
        emoji.textContent = facetData.emoji;
        header.appendChild(emoji);
      }

      const title = document.createElement('span');
      title.textContent = facetData.title || facetName;
      header.appendChild(title);

      section.appendChild(header);
    }

    const contentDiv = document.createElement('div');
    contentDiv.className = 'newsletter-content';

    // Configure marked
    marked.setOptions({
      breaks: true,
      gfm: true,
      headerIds: false,
      mangle: false
    });

    // Remove top-level heading (usually date-based)
    let processedContent = content.replace(/^# .+\n+/, '');

    // Render markdown
    contentDiv.innerHTML = marked.parse(processedContent);
    section.appendChild(contentDiv);

    container.appendChild(section);
  }

  // Initial load
  loadNews();
})();
</script>
