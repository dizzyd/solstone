"""Tests for the facet-scoped todo checklist system."""

from __future__ import annotations

import json
from pathlib import Path

import pytest

from apps.todos.todo import (
    TodoChecklist,
    TodoItem,
    get_facets_with_todos,
    get_todos,
    upcoming,
)


@pytest.fixture
def journal_root(tmp_path):
    path = tmp_path / "journal"
    path.mkdir()
    return path


def _write_todos(root: Path, facet: str, day: str, items: list[dict]) -> Path:
    """Write todos to facets/{facet}/todos/{day}.jsonl"""
    todos_dir = root / "facets" / facet / "todos"
    todos_dir.mkdir(parents=True, exist_ok=True)
    todo_path = todos_dir / f"{day}.jsonl"
    lines = [json.dumps(item, ensure_ascii=False) for item in items]
    todo_path.write_text("\n".join(lines) + "\n", encoding="utf-8")
    return todo_path


def test_get_todos_returns_none_when_missing(monkeypatch, journal_root):
    monkeypatch.setenv("JOURNAL_PATH", str(journal_root))
    assert get_todos("20240101", "personal") is None


def test_get_todos_parses_basic_fields(monkeypatch, journal_root):
    monkeypatch.setenv("JOURNAL_PATH", str(journal_root))
    _write_todos(
        journal_root,
        "personal",
        "20240102",
        [
            {"text": "Merge analytics PR", "time": "10:30"},
            {"text": "Project sync", "completed": True},  # no time
            {"text": "Write retrospective notes"},
        ],
    )

    todos = get_todos("20240102", "personal")
    assert todos is not None
    assert len(todos) == 3

    first = todos[0]
    assert first["index"] == 1
    assert first["time"] == "10:30"
    assert first["completed"] is False
    assert first["text"] == "Merge analytics PR"

    second = todos[1]
    assert second["completed"] is True
    assert second["time"] is None
    assert second["text"] == "Project sync"

    third = todos[2]
    assert third["text"] == "Write retrospective notes"
    assert third["index"] == 3


def test_get_todos_handles_cancelled(monkeypatch, journal_root):
    monkeypatch.setenv("JOURNAL_PATH", str(journal_root))
    _write_todos(
        journal_root,
        "work",
        "20240103",
        [
            {"text": "Optional experiment", "cancelled": True},
            {"text": "Address bug", "time": "14:45"},
            {"text": "Draft report", "completed": True},
        ],
    )

    todos = get_todos("20240103", "work")
    assert todos is not None
    assert len(todos) == 3

    cancelled = todos[0]
    assert cancelled["cancelled"] is True
    assert cancelled["text"] == "Optional experiment"

    second = todos[1]
    assert second["time"] == "14:45"
    assert second["index"] == 2

    third = todos[2]
    assert third["completed"] is True
    assert third["text"] == "Draft report"


def test_get_todos_ignores_blank_lines(monkeypatch, journal_root):
    monkeypatch.setenv("JOURNAL_PATH", str(journal_root))
    # Write with blank lines mixed in
    todos_dir = journal_root / "facets" / "personal" / "todos"
    todos_dir.mkdir(parents=True, exist_ok=True)
    todo_path = todos_dir / "20240104.jsonl"
    todo_path.write_text(
        '\n{"text": "First"}\n\n{"text": "Second"}\n',
        encoding="utf-8",
    )

    todos = get_todos("20240104", "personal")
    assert [item["index"] for item in todos] == [1, 2]


def test_todo_item_display_line():
    """Test TodoItem.display_line() formatting."""
    item = TodoItem(
        index=1, text="Simple task", time=None, completed=False, cancelled=False
    )
    assert item.display_line() == "[ ] Simple task"

    item_done = TodoItem(
        index=2, text="Done task", time=None, completed=True, cancelled=False
    )
    assert item_done.display_line() == "[x] Done task"

    item_cancelled = TodoItem(
        index=3, text="Cancelled task", time=None, completed=False, cancelled=True
    )
    assert item_cancelled.display_line() == "~~[cancelled] Cancelled task~~"

    item_with_time = TodoItem(
        index=4, text="Meeting", time="14:30", completed=False, cancelled=False
    )
    assert item_with_time.display_line() == "[ ] Meeting (14:30)"

    item_cancelled_done = TodoItem(
        index=5, text="Was done", time=None, completed=True, cancelled=True
    )
    assert item_cancelled_done.display_line() == "~~[cancelled] Was done~~"


def test_todo_item_to_jsonl():
    """Test TodoItem.to_jsonl() serialization."""
    item = TodoItem(index=1, text="Task", time=None, completed=False, cancelled=False)
    assert item.to_jsonl() == {"text": "Task"}

    item_full = TodoItem(
        index=2, text="Full task", time="10:00", completed=True, cancelled=False
    )
    assert item_full.to_jsonl() == {
        "text": "Full task",
        "time": "10:00",
        "completed": True,
    }

    item_cancelled = TodoItem(
        index=3, text="Cancelled", time=None, completed=False, cancelled=True
    )
    assert item_cancelled.to_jsonl() == {"text": "Cancelled", "cancelled": True}


def test_todo_item_from_jsonl():
    """Test TodoItem.from_jsonl() parsing."""
    item = TodoItem.from_jsonl({"text": "Simple"}, 1)
    assert item.index == 1
    assert item.text == "Simple"
    assert item.completed is False
    assert item.cancelled is False
    assert item.time is None

    item_full = TodoItem.from_jsonl(
        {"text": "Full", "time": "10:00", "completed": True, "cancelled": False}, 2
    )
    assert item_full.time == "10:00"
    assert item_full.completed is True


def test_upcoming_groups_future_days(monkeypatch, journal_root):
    monkeypatch.setenv("JOURNAL_PATH", str(journal_root))
    # Create facet structure
    (journal_root / "facets" / "personal").mkdir(parents=True)
    (journal_root / "facets" / "personal" / "facet.json").write_text(
        '{"title": "Personal"}', encoding="utf-8"
    )

    _write_todos(
        journal_root,
        "personal",
        "20240105",
        [
            {"text": "First future task"},
            {"text": "Completed future task", "completed": True},
        ],
    )
    _write_todos(
        journal_root,
        "personal",
        "20240106",
        [
            {"text": "Another future task"},
        ],
    )
    _write_todos(
        journal_root,
        "personal",
        "20240103",
        [
            {"text": "Past task"},
        ],
    )

    result = upcoming(today="20240104")

    expected = (
        "### Personal: 20240105\n"
        "[ ] First future task\n"
        "[x] Completed future task\n\n"
        "### Personal: 20240106\n"
        "[ ] Another future task"
    )

    assert result == expected


def test_upcoming_respects_limit(monkeypatch, journal_root):
    monkeypatch.setenv("JOURNAL_PATH", str(journal_root))
    # Create facet structure
    (journal_root / "facets" / "work").mkdir(parents=True)
    (journal_root / "facets" / "work" / "facet.json").write_text(
        '{"title": "Work"}', encoding="utf-8"
    )

    _write_todos(
        journal_root,
        "work",
        "20240105",
        [
            {"text": "Task one"},
            {"text": "Task two"},
            {"text": "Task three"},
        ],
    )

    result = upcoming(limit=2, today="20240104")

    expected = "### Work: 20240105\n" "[ ] Task one\n" "[ ] Task two"

    assert result == expected


def test_upcoming_excludes_cancelled(monkeypatch, journal_root):
    """Cancelled todos should not appear in upcoming view."""
    monkeypatch.setenv("JOURNAL_PATH", str(journal_root))
    (journal_root / "facets" / "personal").mkdir(parents=True)
    (journal_root / "facets" / "personal" / "facet.json").write_text(
        '{"title": "Personal"}', encoding="utf-8"
    )

    _write_todos(
        journal_root,
        "personal",
        "20240105",
        [
            {"text": "Active task"},
            {"text": "Cancelled task", "cancelled": True},
            {"text": "Another active"},
        ],
    )

    result = upcoming(today="20240104")

    assert "Active task" in result
    assert "Another active" in result
    assert "Cancelled task" not in result


def test_upcoming_when_no_future_todos(monkeypatch, journal_root):
    monkeypatch.setenv("JOURNAL_PATH", str(journal_root))
    (journal_root / "facets" / "personal").mkdir(parents=True)

    _write_todos(
        journal_root,
        "personal",
        "20240102",
        [
            {"text": "Existing task"},
        ],
    )

    result = upcoming(today="20240102")

    assert result == "No upcoming todos."


def test_upcoming_filters_by_facet(monkeypatch, journal_root):
    monkeypatch.setenv("JOURNAL_PATH", str(journal_root))
    # Create multiple facets
    for facet_name in ["personal", "work"]:
        facet_dir = journal_root / "facets" / facet_name
        facet_dir.mkdir(parents=True)
        (facet_dir / "facet.json").write_text(
            f'{{"title": "{facet_name.title()}"}}', encoding="utf-8"
        )

    _write_todos(journal_root, "personal", "20240105", [{"text": "Personal task"}])
    _write_todos(journal_root, "work", "20240105", [{"text": "Work task"}])

    # Test filtering by facet
    result = upcoming(facet="personal", today="20240104")
    assert "Personal: 20240105" in result
    assert "Personal task" in result
    assert "Work task" not in result


def test_upcoming_aggregates_all_facets(monkeypatch, journal_root):
    monkeypatch.setenv("JOURNAL_PATH", str(journal_root))
    # Create multiple facets
    for facet_name in ["personal", "work"]:
        facet_dir = journal_root / "facets" / facet_name
        facet_dir.mkdir(parents=True)
        (facet_dir / "facet.json").write_text(
            f'{{"title": "{facet_name.title()}"}}', encoding="utf-8"
        )

    _write_todos(journal_root, "personal", "20240105", [{"text": "Personal task"}])
    _write_todos(journal_root, "work", "20240105", [{"text": "Work task"}])

    # Test aggregation (facet=None)
    result = upcoming(facet=None, today="20240104")
    assert "Personal: 20240105" in result
    assert "Work: 20240105" in result
    assert "Personal task" in result
    assert "Work task" in result


def test_checklist_append_entry(monkeypatch, journal_root):
    """Test TodoChecklist.append_entry() creates valid JSONL."""
    monkeypatch.setenv("JOURNAL_PATH", str(journal_root))

    # Create facet directory
    facets_dir = journal_root / "facets" / "work"
    facets_dir.mkdir(parents=True)

    checklist = TodoChecklist.load("20240105", "work")

    # Test normal entry works
    item = checklist.append_entry("Test task (10:30)")
    assert len(checklist.items) == 1
    assert item.text == "Test task"
    assert item.time == "10:30"

    # Verify file contents
    content = checklist.path.read_text(encoding="utf-8")
    data = json.loads(content.strip())
    assert data["text"] == "Test task"
    assert data["time"] == "10:30"


def test_checklist_cancel_entry(monkeypatch, journal_root):
    """Test TodoChecklist.cancel_entry() soft-deletes items."""
    monkeypatch.setenv("JOURNAL_PATH", str(journal_root))

    _write_todos(
        journal_root,
        "personal",
        "20240105",
        [{"text": "Task to cancel"}],
    )

    checklist = TodoChecklist.load("20240105", "personal")
    item = checklist.cancel_entry(1)

    assert item.cancelled is True
    assert checklist.items[0].cancelled is True

    # Verify file was updated
    content = checklist.path.read_text(encoding="utf-8")
    data = json.loads(content.strip())
    assert data["cancelled"] is True


def test_checklist_display_includes_cancelled_with_strikethrough(
    monkeypatch, journal_root
):
    """Test TodoChecklist.display() always includes cancelled items with strikethrough."""
    monkeypatch.setenv("JOURNAL_PATH", str(journal_root))

    _write_todos(
        journal_root,
        "personal",
        "20240105",
        [
            {"text": "Active task"},
            {"text": "Cancelled task", "cancelled": True},
            {"text": "Another active"},
        ],
    )

    checklist = TodoChecklist.load("20240105", "personal")

    # All items included, cancelled ones have strikethrough
    display = checklist.display()
    assert "1: [ ] Active task" in display
    assert "2: ~~[cancelled] Cancelled task~~" in display
    assert "3: [ ] Another active" in display


def test_get_facets_with_todos(monkeypatch, journal_root):
    monkeypatch.setenv("JOURNAL_PATH", str(journal_root))

    # Create todos in multiple facets
    _write_todos(journal_root, "personal", "20240105", [{"text": "Personal task"}])
    _write_todos(journal_root, "work", "20240105", [{"text": "Work task"}])
    _write_todos(journal_root, "hobby", "20240106", [{"text": "Hobby task"}])

    # Test getting facets for a specific day
    facets_20240105 = get_facets_with_todos("20240105")
    assert sorted(facets_20240105) == ["personal", "work"]

    facets_20240106 = get_facets_with_todos("20240106")
    assert facets_20240106 == ["hobby"]

    facets_20240107 = get_facets_with_todos("20240107")
    assert facets_20240107 == []
