{% extends 'base.html' %}
{% set title = 'Import' %}
{% set active = 'import' %}
{% block head %}
<style>
.container { padding:0 1em; }
#dropArea { border:2px dashed #999; padding:2em; text-align:center; margin-bottom:1em; cursor:pointer; }
#dropArea.dragover { background:#eef; border-color:#333; }
textarea { width:100%; min-height:150px; }
#pasteText { min-height:300px; }
button { margin-top:1em; padding:6px 12px; }
button:disabled { background:#ccc; color:#666; cursor:not-allowed; opacity:0.6; }
.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
.modal-content { background:white; margin:5% auto; padding:1em; border-radius:8px; max-width:800px; max-height:80vh; overflow:auto; position:relative; }
.close { position:absolute; top:10px; right:15px; cursor:pointer; font-size:24px; }
.spinner { display:inline-block; width:12px; height:12px; border:2px solid #ccc; border-top-color:#333; border-radius:50%; animation:spin 1s linear infinite; margin-left:4px; }
#taskOutput { white-space: pre-wrap; word-wrap: break-word; }
.domain-selector { margin-left: auto; display: flex; align-items: center; gap: 0.5em; }
.domain-selector label { font-size: 0.9em; color: #666; }
.domain-selector select { padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; background: white; }
@keyframes spin { to { transform:rotate(360deg); } }
</style>
{% endblock %}
{% block body %}
<div class="container">
  <div class="tabs">
    <div class="tab active" data-target="media">Media</div>
    <div class="tab" data-target="paste">Paste</div>
    <div class="domain-selector">
      <label for="domainSelect">Domain:</label>
      <select id="domainSelect">
        <option value="">None</option>
      </select>
    </div>
  </div>
  <form id="importForm">
    <div class="content" id="media">
      <div id="dropArea">
        <p>Drag file here or click to select</p>
        <input id="fileInput" type="file" style="display:none" />
        <div id="fileLabel"></div>
      </div>
      <textarea id="freeText" placeholder="Optional text"></textarea>
    </div>
    <div class="content" id="paste" style="display:none">
      <textarea id="pasteText" placeholder="Paste text here"></textarea>
    </div>
    <button type="submit" id="submitBtn">Submit</button>
  </form>
  <h2>Import Log</h2>
  <pre id="logOutput"></pre>
</div>

<div id="detectModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <div>
      <label>Timestamp <input id="timestampInput" /></label>
      <input type="hidden" id="savedPath" />
      <button id="startBtn">Start Import</button>
    </div>
  </div>
</div>

<div id="taskModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <pre id="taskOutput"></pre>
  </div>
</div>

<script>
const tabs = Array.from(document.querySelectorAll('.tab'));
const contents = document.querySelectorAll('.content');
let activeTab = 'media';
function showTab(id){
  tabs.forEach(t=>t.classList.toggle('active', t.dataset.target===id));
  contents.forEach(c=>{c.style.display=c.id===id?'block':'none';});
  activeTab = id;
}
tabs.forEach(t=>t.addEventListener('click', ()=>showTab(t.dataset.target)));

const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');
const fileLabel = document.getElementById('fileLabel');
let currentFile = null;

dropArea.onclick = () => fileInput.click();
['dragenter','dragover'].forEach(ev=>dropArea.addEventListener(ev,e=>{e.preventDefault();dropArea.classList.add('dragover');}));
['dragleave','drop'].forEach(ev=>dropArea.addEventListener(ev,e=>{e.preventDefault();dropArea.classList.remove('dragover');if(ev==='drop'){}}));
dropArea.addEventListener('drop',e=>{const f=e.dataTransfer.files[0];if(f){currentFile=f;fileLabel.textContent=f.name;}});
fileInput.onchange=e=>{currentFile=e.target.files[0];if(currentFile)fileLabel.textContent=currentFile.name;};
document.getElementById('importForm').onsubmit=e=>{
  e.preventDefault();
  const submitBtn = document.getElementById('submitBtn');
  const originalText = submitBtn.textContent;
  
  // Disable button and show processing state
  submitBtn.disabled = true;
  submitBtn.innerHTML = 'Processing<span class="spinner"></span>';
  
  const fd=new FormData();
  if(activeTab==='media'){
    if(currentFile) fd.append('file', currentFile);
    fd.append('text', document.getElementById('freeText').value);
  } else {
    fd.append('text', document.getElementById('pasteText').value);
  }
  // Add selected domain
  const domain = document.getElementById('domainSelect').value;
  if(domain) fd.append('domain', domain);
  fetch('{{ url_for('import_view.import_save') }}', {method:'POST', body:fd})
    .then(async r=>{
      const d=await r.json();
      // Re-enable button
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
      
      if(!r.ok){
        if(window.showError)showError(d.error||'Upload failed');
        return;
      }
      showDetect(d);
    })
    .catch(err=>{
      // Re-enable button on error
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
      if(window.showError)showError('Upload failed');
    });
};
function showDetect(res){
  document.getElementById('timestampInput').value=res.timestamp||'';
  document.getElementById('savedPath').value=res.path;
  document.getElementById('detectModal').style.display='block';
}
function loadLog(){
  fetch('{{ url_for('import_view.import_log') }}').then(r=>r.json()).then(data=>{
    const pre=document.getElementById('logOutput');
    pre.textContent=data.map(e=>new Date(e.time*1000).toLocaleString()+" - "+e.message).join('\n');
  });
}
function runTask(data){
  const modal=document.getElementById('taskModal');
  const out=document.getElementById('taskOutput');
  const content=document.querySelector('#taskModal .modal-content');
  out.innerHTML='';
  modal.style.display='block';
  const spinner=document.createElement('span');
  spinner.className='spinner';
  out.appendChild(spinner);
  const scroll=()=>{content.scrollTop=content.scrollHeight;};
  const addLine=html=>{spinner.remove();out.innerHTML+=html+'\n';out.appendChild(spinner);scroll();};
  const ws=new WebSocket(`ws://${location.host}/ws/tasks`);
  ws.onopen=()=>ws.send(JSON.stringify(data));
  ws.onmessage=e=>{const msg=JSON.parse(e.data);if(msg.type==='stdout')addLine(msg.text);else if(msg.type==='stderr')addLine('<span style="color:red">'+msg.text+'</span>');else if(msg.type==='exit'){spinner.remove();out.innerHTML+='[exit '+msg.code+']\n';scroll();ws.close();}};
  ws.onclose=()=>{spinner.remove();loadLog();};
}
document.getElementById('startBtn').onclick=()=>{
  const ts=document.getElementById('timestampInput').value.trim();
  const path=document.getElementById('savedPath').value;
  document.getElementById('detectModal').style.display='none';
  runTask({task:'importer',day:path+'|'+ts,src:'import'});
};
document.querySelectorAll('.close')[0].onclick=()=>{document.getElementById('detectModal').style.display='none';};
document.querySelectorAll('.close')[1].onclick=()=>{document.getElementById('taskModal').style.display='none';};
window.onclick=e=>{if(e.target==document.getElementById('detectModal'))document.getElementById('detectModal').style.display='none';if(e.target==document.getElementById('taskModal'))document.getElementById('taskModal').style.display='none';};

// Load domains for dropdown
function loadDomains(){
  fetch('{{ url_for('domains.domains_list') }}').then(r=>r.json()).then(domains=>{
    const select=document.getElementById('domainSelect');
    const current=select.value; // Preserve current selection
    select.innerHTML='<option value="">None</option>';
    Object.entries(domains).forEach(([name,data])=>{
      const opt=document.createElement('option');
      opt.value=name;
      opt.textContent=data.title||name;
      if(name===current) opt.selected=true;
      select.appendChild(opt);
    });
  }).catch(()=>{/*ignore*/});
}

// Auto-select domain from URL fragment
function checkUrlFragment(){
  const fragment = window.location.hash.substring(1); // Remove #
  if(fragment){
    const select = document.getElementById('domainSelect');
    const option = select.querySelector(`option[value="${fragment}"]`);
    if(option) {
      option.selected = true;
      // Clear the fragment to avoid confusion
      history.replaceState(null, null, window.location.pathname + window.location.search);
    }
  }
}

loadLog();
loadDomains();
setTimeout(checkUrlFragment, 100); // Wait for domains to load
</script>
{% endblock %}
